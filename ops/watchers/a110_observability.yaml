groups:
- name: a110_observability
  rules:
  # W‑OBS‑001 — p95(swap)
  - alert: OBS_P95_Swap_TooHigh
    expr: histogram_quantile(0.95, sum by (le) (rate(amm_op_latency_seconds_bucket{op="swap"}[5m]))) > 0.06
    for: 10m
    labels:
      severity: warn
      team: ce
    annotations:
      summary: "p95(swap) acima do SLO (60ms)"
      description: "p95 da operação swap excedeu 60ms por 10m. Verificar regressões, GC e cardinalidade."

  - alert: OBS_P95_Swap_TooHigh_Crit
    expr: histogram_quantile(0.95, sum by (le) (rate(amm_op_latency_seconds_bucket{op="swap"}[5m]))) > 0.06
    for: 30m
    labels:
      severity: critical
      team: ce
    annotations:
      summary: "p95(swap) crítico acima de 60ms"
      description: "Persistência >30m. Ação imediata necessária."

  # W‑OBS‑002 — staleness (oracle)
  - alert: OBS_Oracle_Stale
    expr: max by (source) (data_freshness_seconds{source="oracle"}) > 5
    for: 5m
    labels:
      severity: warn
      team: ce
    annotations:
      summary: "Freshness oracle > 5s"
      description: "Dados de oracle acima do alvo de 5s na janela."

  # W‑OBS‑003 — CDC lag
  - alert: OBS_CDC_Lag_Warn
    expr: max by (stream) (cdc_lag_seconds{env=~".+"}) > 10
    for: 10m
    labels:
      severity: warn
      team: ce
    annotations:
      summary: "CDC lag > 10s (WARN)"
      description: "Lag de CDC acima de 10s por 10m."

  - alert: OBS_CDC_Lag_Crit
    expr: max by (stream) (cdc_lag_seconds{env=~".+"}) > 30
    for: 5m
    labels:
      severity: critical
      team: ce
    annotations:
      summary: "CDC lag > 30s (CRIT)"
      description: "Lag de CDC crítico por 5m."

  # W‑OBS‑004 — drift (features críticas)
  - alert: OBS_Drift_Critical_Feature_Warn
    expr: max by (feature) (drift_score{feature=~".*(price|volume|spread).*"}) > 0.2
    for: 30m
    labels:
      severity: warn
      team: ce
    annotations:
      summary: "Drift (PSI/KL) > 0.2 em feature crítica"
      description: "PSI/KL acima de 0.2 por 30m. Verificar regime e baseline."

  - alert: OBS_Drift_Critical_Feature_Crit
    expr: max by (feature) (drift_score{feature=~".*(price|volume|spread).*"}) > 0.4
    for: 15m
    labels:
      severity: critical
      team: ce
    annotations:
      summary: "Drift (PSI/KL) crítico > 0.4"
      description: "PSI/KL acima de 0.4 por 15m em feature crítica. Acionar análise de distribuição."

  # W‑OBS‑005 — hook coverage e execuções
  - alert: OBS_Hook_Coverage_Low
    expr: min by (env) (hook_coverage_ratio{env=~".+"}) < 0.95
    for: 30m
    labels:
      severity: warn
      team: ce
    annotations:
      summary: "Cobertura de hooks <95%"
      description: "Cobertura de hooks caiu abaixo de 95% na janela de 30m. Checar hooks sem execução e falhas recentes."

  - alert: OBS_Hook_Execution_Stalled
    expr: sum by (hook_id) (increase(hook_executions_total{status="success"}[1h])) == 0
    for: 1h
    labels:
      severity: warn
      team: ce
    annotations:
      summary: "Hook sem execuções em 1h"
      description: "O hook {{ $labels.hook_id }} não executou na última hora. Validar cobertura A110 e jobs dependentes."
