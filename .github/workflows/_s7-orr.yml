name: "S7 — ORR (callee)"

on:
  workflow_call:
    inputs:
      run_microbench:
        type: boolean
        required: false
        default: false
      run_tla:
        type: boolean
        required: false
        default: false

permissions:
  contents: read

concurrency:
  group: s7-orr-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  PYTHONHASHSEED: "0"
  TZ: "UTC"
  LC_ALL: "C"
  LANG: "C.UTF-8"

jobs:
  t0_spec:
    name: t0_spec
    runs-on: ubuntu-22.04
    outputs:
      status: ${{ steps.manifest.outputs.status }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - name: Gate T0 — existence
        id: manifest
        run: |
          set -euo pipefail
          MAN="docs/DNA/Roadmap e Sprints/Q2/Sprint 7/s_7_filemap_v_7.json"
          OUT="out/obs_gatecheck/T0_discovery.json"
          mkdir -p "$(dirname "$OUT")"
          status="PASS"
          checked=0
          missing=()
          if [ ! -s "$MAN" ]; then
            status="FAIL"
            printf '{"gate":"T0","status":"FAIL","checked":0,"missing":["s_7_filemap_v_7.json"]}' > "$OUT"
          else
            while IFS= read -r line; do
              path=$(printf '%s\n' "$line" | sed -n 's/.*"path"[[:space:]]*:[[:space:]]*"\(.*\)".*/\1/p')
              if [ -z "$path" ]; then
                continue
              fi
              checked=$((checked + 1))
              if [ ! -f "$path" ]; then
                missing+=("$path")
              fi
            done < "$MAN"
            if [ "${#missing[@]}" -gt 0 ]; then
              status="FAIL"
            fi
            {
              printf '{"gate":"T0","status":"%s","checked":%s,"missing":[' "$status" "$checked"
              if [ "${#missing[@]}" -gt 0 ]; then
                for i in "${!missing[@]}"; do
                  printf '"%s"' "${missing[$i]}"
                  if [ "$i" -lt $((${#missing[@]} - 1)) ]; then
                    printf ','
                  fi
                done
              fi
              printf ']}'
            } > "$OUT"
          fi
          echo "status=$status" >> "$GITHUB_OUTPUT"
      - name: Upload T0 evidence
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: s7-t0-evidence
          path: out/obs_gatecheck/T0_discovery.json
      - name: Fail on T0 discovery issues
        if: steps.manifest.outputs.status == 'FAIL'
        run: |
          echo "::error::T0 manifest checks failed. Review s7-t0-evidence/T0_discovery.json"
          exit 1

  t1_yaml:
    name: t1_yaml
    needs: t0_spec
    runs-on: ubuntu-22.04
    outputs:
      status: ${{ steps.yamllint.outputs.status }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38
        with:
          python-version: '3.11'
      - name: Install yamllint
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          python -m pip install yamllint==1.35.1
      - name: yamllint
        id: yamllint
        run: |
          set -euo pipefail
          mkdir -p out/evidence/T1_yaml
          set +e
          yamllint -s . | tee out/evidence/T1_yaml/yamllint.txt
          rc=${PIPESTATUS[0]}
          set -e
          if [ "$rc" -eq 0 ]; then
            status="PASS"
          else
            status="FAIL"
          fi
          printf '%s\n' "$rc" > out/evidence/T1_yaml/exit_code.txt
          echo "status=$status" >> "$GITHUB_OUTPUT"
      - if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: s7-t1-yaml
          path: out/evidence/T1_yaml
      - name: Fail on YAML issues
        if: steps.yamllint.outputs.status == 'FAIL'
        run: |
          echo "::error::YAML validation failed. See s7-t1-yaml artifact for details."
          exit 1

  t2_security:
    name: t2_security
    needs: t0_spec
    runs-on: ubuntu-22.04
    outputs:
      status: ${{ steps.gitleaks.outputs.status }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - name: Install gitleaks
        run: |
          set -euo pipefail
          VER="8.18.1"
          URL="https://github.com/gitleaks/gitleaks/releases/download/v${VER}/gitleaks_${VER}_linux_x64.tar.gz"
          curl -fsSL "$URL" -o gitleaks.tgz
          tar -xzf gitleaks.tgz gitleaks
          sudo install -m 0755 gitleaks /usr/local/bin/gitleaks
          gitleaks version
      - name: Run gitleaks
        id: gitleaks
        run: |
          set -euo pipefail
          mkdir -p out/evidence/T2_security
          set +e
          gitleaks detect --source . --no-banner --redact --report-format json \
            --report-path out/evidence/T2_security/gitleaks_report.json
          rc=$?
          set -e
          printf '%s\n' "$rc" > out/evidence/T2_security/exit_code.txt
          if [ "$rc" -eq 0 ]; then
            status="PASS"
          else
            status="FAIL"
          fi
          echo "status=$status" >> "$GITHUB_OUTPUT"
      - if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: s7-t2-security
          path: out/evidence/T2_security
      - name: Fail on gitleaks findings
        if: steps.gitleaks.outputs.status == 'FAIL'
        run: |
          echo "::error::Gitleaks detected issues. Review s7-t2-security artifact."
          exit 1

  t3_pins:
    name: t3_pins
    needs: t0_spec
    runs-on: ubuntu-22.04
    outputs:
      status: ${{ steps.scan.outputs.status }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - name: scan pins
        id: scan
        run: |
          set -euo pipefail
          mkdir -p out/evidence/T3_pins
          rg --line-number -e 'uses:[[:space:]]*"?actions/.+@' .github/workflows | tee out/evidence/T3_pins/pins.txt || true
          python - <<'PY'
import json
import re
from pathlib import Path

CANONICAL = {
    "actions/checkout": "11bd71901bbe5b1630ceea73d27597364c9af683",
    "actions/upload-artifact": "ea165f8d65b6e75b540449e92b4886f43607fa02",
    "actions/download-artifact": "d3f86a106a0bac45b974a628896c90dbdf5c8093",
    "actions/setup-python": "42375524e23c412d93fb67b49958b491fce71c38",
}
pattern = re.compile(r"uses:\s*"?([\w.-]+/[\w.-]+)@([A-Za-z0-9]+)")
issues = []
for path in Path(".github/workflows").rglob("*.yml"):
    for idx, line in enumerate(path.read_text().splitlines(), start=1):
        match = pattern.search(line)
        if not match:
            continue
        action, ref = match.groups()
        if action in CANONICAL and CANONICAL[action] != ref:
            issues.append({
                "file": str(path),
                "line": idx,
                "action": action,
                "expected": CANONICAL[action],
                "found": ref,
            })
Path("out/evidence/T3_pins/pin_audit.json").write_text(json.dumps({"issues": issues}, indent=2), encoding="utf-8")
PY
          python - <<'PY'
import json
from pathlib import Path
pin_path = Path("out/evidence/T3_pins/pin_audit.json")
if not pin_path.exists():
    pin_path.write_text(json.dumps({"issues": []}, indent=2), encoding="utf-8")
PY
          status=$(python - <<'PY'
import json
from pathlib import Path
pin_path = Path("out/evidence/T3_pins/pin_audit.json")
if pin_path.exists():
    data = json.loads(pin_path.read_text())
else:
    data = {"issues": []}
print("FAIL" if data.get("issues") else "PASS")
PY
)
          echo "status=$status" >> "$GITHUB_OUTPUT"
      - if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: s7-t3-pins
          path: out/evidence/T3_pins
      - name: Fail on pinning issues
        if: steps.scan.outputs.status == 'FAIL'
        run: |
          echo "::error::Non-canonical GitHub Action pin detected. Review s7-t3-pins artifact."
          exit 1

  t4_tests:
    name: t4_tests (py${{ matrix.py }})
    needs: t0_spec
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        py: ["3.11.9", "3.11.14"]
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38
        with:
          python-version: ${{ matrix.py }}
      - name: run pytest (if present)
        id: run_tests
        env:
          PY_VERSION: ${{ matrix.py }}
        run: |
          set -euo pipefail
          out_dir="out/evidence/T4_tests/${PY_VERSION}"
          mkdir -p "$out_dir"
          status="SKIP"
          pip_upgrade_rc=0
          pip_install_rc=0
          freeze_rc=0
          pytest_rc=0
          if [ -d tests ]; then
            status="PASS"
            set +e
            python -m pip install --upgrade pip 2>&1 | tee "$out_dir/pip-upgrade.log"
            pip_upgrade_rc=${PIPESTATUS[0]}
            python -m pip install ".[dev]" 2>&1 | tee "$out_dir/pip-install.log"
            pip_install_rc=${PIPESTATUS[0]}
            pip freeze > "$out_dir/requirements-freeze.txt"
            freeze_rc=$?
            pytest -q 2>&1 | tee "$out_dir/pytest.txt"
            pytest_rc=${PIPESTATUS[0]}
            set -e
            printf '%s\n' "$pytest_rc" > "$out_dir/pytest-exit-code.txt"
            if [ "$pip_upgrade_rc" -ne 0 ] || [ "$pip_install_rc" -ne 0 ] || [ "$pytest_rc" -ne 0 ] || [ "$freeze_rc" -ne 0 ]; then
              status="FAIL"
            fi
          else
            echo "skip: no tests directory present" | tee "$out_dir/pytest.txt"
            printf 'skip\n' > "$out_dir/pytest-exit-code.txt"
            printf 'skip\n' > "$out_dir/requirements-freeze.txt"
          fi
          echo "status=$status" >> "$GITHUB_OUTPUT"
      - if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: s7-t4-tests
          path: out/evidence/T4_tests
      - name: Fail on pytest errors
        if: steps.run_tests.outputs.status == 'FAIL'
        run: |
          echo "::error::pytest failed for Python ${{ matrix.py }}. See s7-t4-tests artifact."
          exit 1

  t5_props:
    name: t5_props
    needs: t0_spec
    runs-on: ubuntu-22.04
    outputs:
      status: ${{ steps.placeholder.outputs.status }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - name: Placeholder properties report
        id: placeholder
        run: |
          set -euo pipefail
          mkdir -p out/evidence/T5_props
          echo "TODO: implementar propriedades" > out/evidence/T5_props/props.txt
          echo "status=TODO" >> "$GITHUB_OUTPUT"
      - if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: s7-t5-props
          path: out/evidence/T5_props

  t6_determinism:
    name: t6_determinism (py${{ matrix.py }})
    needs: t0_spec
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        py: ["3.11.9", "3.11.14"]
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38
        with:
          python-version: ${{ matrix.py }}
      - name: Determinism placeholder
        id: det
        env:
          PY_VERSION: ${{ matrix.py }}
        run: |
          set -euo pipefail
          out_dir="out/evidence/T6_determinism/${PY_VERSION}"
          mkdir -p "$out_dir"
          OUT_DIR=$out_dir python - <<'PY'
import json
import os
from pathlib import Path

out_dir = Path(os.environ['OUT_DIR'])
data = {
    'determinism_check': 'TODO',
    'python_version': os.environ['PY_VERSION'],
    'note': 'Adicionar verificações determinísticas reais (sorted outputs, random.seed(1337)).',
}
(out_dir / 'det_report.json').write_text(json.dumps(data, indent=2), encoding='utf-8')
PY
          printf 'TODO\n' > "$out_dir/status.txt"
          echo "status=TODO" >> "$GITHUB_OUTPUT"
      - if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: s7-t6-determinism
          path: out/evidence/T6_determinism

  t7_append_only:
    name: t7_append_only
    needs: t0_spec
    runs-on: ubuntu-22.04
    outputs:
      status: ${{ steps.guard.outputs.status }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - name: append-only guard
        id: guard
        run: |
          set -euo pipefail
          mkdir -p out/evidence/T7_append_only
          BASE_DIR="obs/guards/append_only/baseline"
          REPORT="out/evidence/T7_append_only/report.txt"
          mkdir -p "$BASE_DIR"
          : > "$REPORT"
          mapfile -t targets < <(git ls-files 'data/**/*.jsonl' 'data/**/*.ndjson' 2>/dev/null)
          status="PASS"
          if [ "${#targets[@]}" -eq 0 ]; then
            status="SKIP"
            echo "no append-only targets found" > "$REPORT"
          else
            for target in "${targets[@]}"; do
              safe_name="${target//\//__}.baseline"
              baseline="$BASE_DIR/$safe_name"
              if [ ! -f "$baseline" ]; then
                cp "$target" "$baseline"
                echo "baseline generated for $target" >> "$REPORT"
                status="FAIL"
                continue
              fi
              tmp_diff=$(mktemp)
              diff -U0 <(sed 's/[[:space:]]\+$//' "$baseline") <(sed 's/[[:space:]]\+$//' "$target") > "$tmp_diff" || true
              if awk 'BEGIN{ok=0} /^-/ { if ($0 !~ /^---/) ok=1 } END{ exit ok == 0 ? 0 : 1 }' "$tmp_diff"; then
                echo "ok: append-only preserved $target" >> "$REPORT"
              else
                echo "FAIL: non-append change detected in $target" >> "$REPORT"
                status="FAIL"
              fi
              rm -f "$tmp_diff"
            done
            while IFS= read -r -d '' baseline_file; do
              rel="${baseline_file#${BASE_DIR}/}"
              target_path="${rel%.baseline}"
              target_path="${target_path//__/\/}"
              if [ ! -f "$target_path" ]; then
                echo "FAIL: baseline has no matching target for $target_path" >> "$REPORT"
                status="FAIL"
              fi
            done < <(find "$BASE_DIR" -type f -name '*.baseline' -print0)
          fi
          echo "status=$status" >> "$GITHUB_OUTPUT"
      - if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: s7-t7-append-only
          path: out/evidence/T7_append_only
      - name: Fail on append-only issues
        if: steps.guard.outputs.status == 'FAIL'
        run: |
          echo "::error::Append-only guard failed. Review s7-t7-append-only artifact."
          exit 1

  t8_pack:
    name: t8_pack
    needs:
      - t0_spec
      - t1_yaml
      - t2_security
      - t3_pins
      - t4_tests
      - t5_props
      - t6_determinism
      - t7_append_only
    if: always()
    runs-on: ubuntu-22.04
    env:
      T0_STATUS: ${{ needs.t0_spec.outputs.status || '' }}
      T0_RESULT: ${{ needs.t0_spec.result }}
      T1_STATUS: ${{ needs.t1_yaml.outputs.status || '' }}
      T1_RESULT: ${{ needs.t1_yaml.result }}
      T2_STATUS: ${{ needs.t2_security.outputs.status || '' }}
      T2_RESULT: ${{ needs.t2_security.result }}
      T3_STATUS: ${{ needs.t3_pins.outputs.status || '' }}
      T3_RESULT: ${{ needs.t3_pins.result }}
      T4_RESULT: ${{ needs.t4_tests.result }}
      T5_STATUS: ${{ needs.t5_props.outputs.status || '' }}
      T5_RESULT: ${{ needs.t5_props.result }}
      T6_RESULT: ${{ needs.t6_determinism.result }}
      T7_STATUS: ${{ needs.t7_append_only.outputs.status || '' }}
      T7_RESULT: ${{ needs.t7_append_only.result }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      - name: pack bundle
        run: |
          set -euo pipefail
          mkdir -p out/orr_bundle
          python - <<'PY'
import json
import os
from pathlib import Path

def resolve_status(status_env: str | None, result_env: str | None) -> str:
    status_env = (status_env or "").strip()
    if status_env:
        return status_env
    result_env = (result_env or "").strip().lower()
    mapping = {
        "success": "PASS",
        "failure": "FAIL",
        "failed": "FAIL",
        "cancelled": "CANCELLED",
        "skipped": "SKIP",
    }
    return mapping.get(result_env, result_env.upper() if result_env else "UNKNOWN")

gates = []
for gate, artifact in [
    ("T0", "s7-t0-evidence"),
    ("T1", "s7-t1-yaml"),
    ("T2", "s7-t2-security"),
    ("T3", "s7-t3-pins"),
    ("T4", "s7-t4-tests"),
    ("T5", "s7-t5-props"),
    ("T6", "s7-t6-determinism"),
    ("T7", "s7-t7-append-only"),
]:
    status = resolve_status(os.getenv(f"{gate}_STATUS"), os.getenv(f"{gate}_RESULT"))
    gates.append({
        "gate": gate,
        "status": status,
        "artifact": artifact,
    })
counts: dict[str, int] = {}
for entry in gates:
    counts[entry["status"]] = counts.get(entry["status"], 0) + 1
summary = {
    "run_id": os.getenv("GITHUB_RUN_ID"),
    "run_attempt": os.getenv("GITHUB_RUN_ATTEMPT"),
    "gates": gates,
    "status_counts": counts,
}
Path("out/orr_bundle/summary.json").write_text(json.dumps(summary, indent=2), encoding="utf-8")
PY
      - uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: s7-orr-evidence
          path: out/orr_bundle
