name: Repo — Sanity (canonical & denylist)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  repo-guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0

      - name: Guard — pins devem ser SHAs
        run: python scripts/check_action_pins.py

      - name: Guard — actions.lock em sincronia
        run: python scripts/ensure_actions_lock_sync.py

      - name: Guard: bloquear uses @v*
        run: |
          set -euo pipefail
          if rg -n "uses:\\s*[A-Za-z0-9_.-]+/[A-Za-z0-9_.-]+@v[0-9]" .github/workflows; then
            echo "[guard] Encontrado uses @v* — bloqueando" >&2
            exit 2
          fi

      - name: Run repo guard (denylist)
        shell: bash
        run: bash scripts/ci_repo_guard.sh

      - name: Upload guard report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # pinned (was v4)
        with:
          name: repo-guard-report
          path: out/repo_guard/**/*.txt
