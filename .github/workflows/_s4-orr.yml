name: _S4 ORR (Reusable)


on:
  workflow_call:
    inputs:
      ref:

        required: false


        type: string
      test_mode:
        required: false
        type: boolean
        default: false
  workflow_dispatch:
    inputs:
      ref:
        description: 'git ref (optional)'





        required: false


        type: string
      test_mode:
        description: 'Quick check: deps + dbt docs only'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  actions: write

concurrency:
  group: s4-orr-${{ inputs.ref || github.sha }}
  cancel-in-progress: true

jobs:
  orr:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    env:
      PROM: http://127.0.0.1:9090

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.sha }}

      - name: Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: System deps
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      # ---- Python deps (dbt only) + audit ----
      - name: Install Python deps (dbt only)



        run: |
          python -m pip install --upgrade pip
          pip install "dbt-core==1.6.4" "dbt-bigquery==1.6.4" "requests==2.31.0"

      - name: Python env audit (pip, freeze)

        run: |
          python -m pip --version | tee pip-version.txt
          pip freeze | sort | tee pip-freeze.txt



      - name: Upload pip audit
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit
          path: |
            pip-version.txt
            pip-freeze.txt

      # ---- Security tools (binários) ----
      - name: Security tools (Trivy & Gitleaks)
        run: |
          curl -sL https://github.com/aquasecurity/trivy/releases/download/v0.53.0/trivy_0.53.0_Linux-64bit.tar.gz | tar xz
          sudo mv trivy /usr/local/bin/
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.18.4/gitleaks_8.18.4_linux_x64.tar.gz | tar xz
          sudo mv gitleaks /usr/local/bin/

      - name: Semgrep (binary v1.80.0, SHA256 verify)
        run: |
          curl -sSLo semgrep https://github.com/semgrep/semgrep/releases/download/v1.80.0/semgrep-linux-amd64
          curl -sSLo semgrep.sha256 https://github.com/semgrep/semgrep/releases/download/v1.80.0/semgrep-linux-amd64.sha256
          sha256sum -c semgrep.sha256
          sudo install -m 0755 semgrep /usr/local/bin/semgrep
          semgrep --version

      # ---- k6 image pinned by digest ----
      - name: Resolve k6 image digest
        id: k6
        run: |
          IMG=grafana/k6:0.52.0
          docker pull "$IMG" >/dev/null
          DIG=$(docker inspect --format='{{index .RepoDigests 0}}' "$IMG")
          echo "image=$DIG" >> "$GITHUB_OUTPUT"

      # ---- dbt build → docs (sempre roda; cobre test_mode) ----
      - name: dbt build
        run: |
          dbt build --project-dir analytics/dbt --profiles-dir analytics/dbt/profiles

      - name: Generate dbt docs
        run: |
          dbt docs generate --project-dir analytics/dbt --profiles-dir analytics/dbt/profiles

      - name: Upload dbt docs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dbt-docs
          path: |
            analytics/dbt/target/catalog.json
            analytics/dbt/target/manifest.json
            analytics/dbt/target/index.html

      # ---- ORR completo só fora de test_mode ----
      - name: ORR run
        if: ${{ !inputs.test_mode }}
        env:
          K6_IMAGE: ${{ steps.k6.outputs.image }}
        run: |
          export K6="docker run --rm -i -v $PWD:/work -w /work $K6_IMAGE"
          sed -i '1s/^/export K6="'"$K6"'"\n/' scripts/orr_s4_run.sh || true
          bash scripts/orr_s4_run.sh

      - name: Upload bundle
        if: ${{ !inputs.test_mode && always() }}
        uses: actions/upload-artifact@v4
        with:
          name: s4_evidence_bundle
          path: out/s4_evidence_bundle_*.zip
