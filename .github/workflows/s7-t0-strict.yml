name: "S7 — Gate T0 (strict)"
on:
  push:
    paths:
      - "docs/DNA/Roadmap e Sprints/Q2/Sprint 7/**"
      - ".github/workflows/s7-t0-strict.yml"
  pull_request:
    paths:
      - "docs/DNA/Roadmap e Sprints/Q2/Sprint 7/**"
      - ".github/workflows/s7-t0-strict.yml"
  workflow_dispatch: {}
permissions:
  contents: read
concurrency:
  group: s7-t0-strict-${{ github.ref }}
  cancel-in-progress: true
defaults:
  run:
    shell: bash

jobs:
  t0:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Evaluate manifest (strict mode)
        id: gate
        run: |
          set -euo pipefail
          scripts/ci/t0_gate.sh --mode fast
          status=$(jq -r '.status' out/obs_gatecheck/T0_discovery.json)
          echo "status=$status" >> "$GITHUB_OUTPUT"
      - name: Upload evidência T0 (strict)
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: s7-t0-strict-evidence
          path: out/obs_gatecheck/T0_discovery.json
          retention-days: 7
      - name: Falha se T0 estiver inválido
        if: always() && steps.gate.outputs.status == 'FAIL'
        run: |
          set -euo pipefail
          echo "::error::T0 manifest check falhou (modo estrito)."
          exit 1
