name: "S7 — Gate T0 (strict)"
on:
  push:
    paths:
      - "docs/DNA/Roadmap e Sprints/Q2/Sprint 7/**"
      - ".github/workflows/s7-t0-strict.yml"
  pull_request:
    paths:
      - "docs/DNA/Roadmap e Sprints/Q2/Sprint 7/**"
      - ".github/workflows/s7-t0-strict.yml"
  workflow_dispatch: {}

jobs:
  t0:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Gate T0 — existência + SHA1 (strict, hardened)
        shell: bash
        run: |
          set -euo pipefail
          MAN='docs/DNA/Roadmap e Sprints/Q2/Sprint 7/s_7_filemap_v_7.json'
          OUT='out/obs_gatecheck/T0_discovery.json'
          mkdir -p "$(dirname "$OUT")"

          if [ ! -s "$MAN" ]; then
            echo '{"gate":"T0","status":"FAIL","reason":"no_manifest","checked":0}' > "$OUT"
            cat "$OUT"; exit 1
          fi

          checked=0; declare -a miss bad
          while IFS= read -r row; do
            # row é base64: {p:path, s:sha1}
            p="$(printf '%s' "$row" | base64 -d | jq -r '.p // empty')"
            s="$(printf '%s' "$row" | base64 -d | jq -r '.s // empty')"
            [ -z "$p" ] && continue
            checked=$((checked+1))

            if [ ! -f "$p" ]; then
              echo "::error file=$p::T0 missing"
              miss+=("$p")
              continue
            fi

            if [ -n "$s" ]; then
              calc="$(git hash-object "$p")"
              if [ "$calc" != "$s" ]; then
                echo "::warning file=$p::sha1 mismatch (calc=$calc expected=$s)"
                bad+=("$p")
              fi
            fi
          done < <(jq -r -c '{p:.path,s:.sha1}|@base64' "$MAN")

          {
            printf '{"gate":"T0","status":"%s","checked":%s' "$([ ${#miss[@]} -eq 0 ] && [ ${#bad[@]} -eq 0 ] && echo PASS || echo FAIL)" "$checked"
            if [ ${#miss[@]} -gt 0 ]; then
              printf ',"missing":['; for i in "${!miss[@]}"; do printf '"%s"%s' "${miss[$i]}" $([ "$i" -lt $((${#miss[@]}-1)) ] && echo , ); done; printf ']'
            fi
            if [ ${#bad[@]} -gt 0 ]; then
              printf ',"sha1_mismatch":['; for i in "${!bad[@]}"; do printf '"%s"%s' "${bad[$i]}" $([ "$i" -lt $((${#bad[@]}-1)) ] && echo , ); done; printf ']'
            fi
            printf '}\n'
          } | tee "$OUT"

          # Falha somente em caso de problema real
          if [ ${#miss[@]} -gt 0 ] || [ ${#bad[@]} -gt 0 ]; then exit 1; fi

      - name: Upload evidência T0 (strict)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: s7-t0-strict-evidence
          path: out/obs_gatecheck/T0_discovery.json
