name: "S7 — Gate T0 (strict)"
on:
  push:
    paths:
      - "docs/DNA/Roadmap e Sprints/Q2/Sprint 7/**"
      - ".github/workflows/s7-t0-strict.yml"
  pull_request:
    paths:
      - "docs/DNA/Roadmap e Sprints/Q2/Sprint 7/**"
      - ".github/workflows/s7-t0-strict.yml"
  workflow_dispatch: {}

jobs:
  t0:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # pinned (v4 SHA)
      - name: Gate T0 — existência + SHA1 (STRICT, jq)
        shell: bash
        run: |
          set -euo pipefail
          MAN='docs/DNA/Roadmap e Sprints/Q2/Sprint 7/s_7_filemap_v_7.json'
          OUT='out/obs_gatecheck/T0_discovery.json'
          mkdir -p "$(dirname "$OUT")"

          if [ ! -s "$MAN" ]; then
            echo '{"gate":"T0","status":"FAIL","reason":"no_manifest","checked":0}' | tee "$OUT"
            exit 1
          fi

          checked=0; declare -a miss bad

          # Lê cada linha-JSON do manifesto de forma segura
          while IFS= read -r line; do
            p="$(jq -r 'try .path // empty' <<<"$line")"
            s="$(jq -r 'try .sha1 // empty' <<<"$line")"
            [ -z "$p" ] && continue
            checked=$((checked+1))
            if [ ! -f "$p" ]; then
              echo "::error file=$p::T0 missing"
              miss+=("$p")
              continue
            fi
            if [ -n "$s" ]; then
              calc="$(git hash-object "$p")"
              if [ "$calc" != "$s" ]; then
                echo "::warning file=$p::sha1 mismatch (calc=$calc expected=$s)"
                bad+=("$p")
              fi
            fi
          done < "$MAN"

          status='PASS'; if [ ${#miss[@]} -gt 0 ] || [ ${#bad[@]} -gt 0 ]; then status='FAIL'; fi

          # Constrói arrays JSON com jq (sem truncar)
          miss_json='[]'; [ ${#miss[@]} -gt 0 ] && miss_json="$(printf '%s\n' "${miss[@]}" | jq -R . | jq -s .)"
          bad_json='[]';  [ ${#bad[@]}  -gt 0 ] && bad_json="$(printf  '%s\n' "${bad[@]}"  | jq -R . | jq -s .)"

          jq -n \
            --arg status "$status" \
            --argjson checked "$checked" \
            --argjson missing "$miss_json" \
            --argjson bad "$bad_json" \
            '{gate:"T0",status:$status,checked:$checked,missing:$missing,sha1_mismatch:$bad}' \
            | tee "$OUT"

          [ "$status" = "PASS" ] || exit 1

      - name: Upload evidência T0 (strict)
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # pinned (v4 SHA)
        with:
          name: s7-t0-strict-evidence
          path: out/obs_gatecheck/T0_discovery.json
