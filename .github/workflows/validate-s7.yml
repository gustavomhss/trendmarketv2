name: validate-s7

on:
  pull_request:
    paths:
      - contracts/data/event_v1.json
      - services/oracle/normalizer/**
      - scripts/crypto/**
      - docs/ADR/**
      - models/tla/append_only/**
      - tests/test_normalizer.py
      - tests/test_signature.py
      - tests/goldens/normalizer/**
      - .github/workflows/validate-s7.yml
      - scripts/ci/validate_s7.py
      - scripts/ci/generate_canonical_batch.py
      - scripts/ci/audit_reusable_workflows.py
  workflow_dispatch: {}

jobs:
  validate:
    name: S7 validation
    runs-on: ubuntu-22.04
    env:
      PYTHONPATH: ${{ github.workspace }}
    permissions:
      contents: read
      actions: read
      checks: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # pinned (was v4)
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38  # pinned (was v5)
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff pytest pynacl cryptography psutil pyyaml

      - name: Actionlint
        uses: reviewdog/action-actionlint@b7d45b0944b77dae1f21a196ee83fed3673d299c  # pinned (was v1)
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: github-check
          fail_level: error
          actionlint_flags: "-shellcheck= .github/workflows/validate-s7.yml .github/workflows/_s4-orr.yml"


      - name: Ruff lint
        run: ruff check .

      - name: Pytest
        run: pytest -q tests/test_normalizer.py tests/test_signature.py

      - name: Generate canonical batch
        run: python -m scripts.ci.generate_canonical_batch

      - name: Check signing seed present
        env:
          ORACLE_ED25519_SEED: ${{ secrets.ORACLE_ED25519_SEED }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${ORACLE_ED25519_SEED:-}" ]; then
            echo "::error title=Missing signing seed::Set repository secret ORACLE_ED25519_SEED (base64 of 32 random bytes)."
            exit 1
          fi

      - name: Sign batch
        env:
          ORACLE_ED25519_SEED: ${{ secrets.ORACLE_ED25519_SEED }}
        run: python scripts/crypto/sign_batch.py

      - name: Verify signature
        run: python scripts/crypto/verify_signature.py

      - name: Validate sprint gates
        run: python scripts/ci/validate_s7.py

      - name: Audit reusable workflows
        run: python scripts/ci/audit_reusable_workflows.py

      - name: Upload validation artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # pinned (was v4)
        with:
          name: s7-validation-artifacts
          path: |
            out/reports/validation/
            out/evidence/S7_event_model/

  call-orr:
    name: ORR gates (_s4-orr)
    uses: ./.github/workflows/_s4-orr.yml
    needs: validate
    with:
      run_tla: true
      ref: ${{ github.sha }}
    secrets: inherit
