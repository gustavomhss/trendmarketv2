name: "S7 — Gate T0 (spec discovery)"
on:
  push:
    paths:
      - "docs/DNA/Roadmap e Sprints/Q2/Sprint 7/**"
      - ".github/workflows/s7-t0.yml"
  pull_request:
    paths:
      - "docs/DNA/Roadmap e Sprints/Q2/Sprint 7/**"
      - ".github/workflows/s7-t0.yml"
  workflow_dispatch: {}

jobs:
  t0:
    runs-on: ubuntu-22.04
    concurrency:
      group: s7-t0-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Gate T0 — validar existência + SHA1
        shell: bash
        run: |
          set -euo pipefail
          MAN='docs/DNA/Roadmap e Sprints/Q2/Sprint 7/s_7_filemap_v_7.json'
          OUT='out/obs_gatecheck/T0_discovery.json'
          mkdir -p "$(dirname "$OUT")"
          [ -s "$MAN" ] || { echo '{"gate":"T0","status":"FAIL","reason":"no_manifest","checked":0}' > "$OUT"; cat "$OUT"; exit 1; }
          checked=0; miss=(); bad=()
          while IFS= read -r line; do
            path=$(printf '%s\n' "$line" | sed -n 's/.*"path"[[:space:]]*:[[:space:]]*"\(.*\)".*/\1/p'); [ -z "$path" ] && continue
            sha1=$(printf '%s\n' "$line" | sed -n 's/.*"sha1"[[:space:]]*:[[:space:]]*"\([0-9a-f]\{40\}\)".*/\1/p')
            checked=$((checked+1))
            if [ ! -f "$path" ]; then miss+=("$path"); continue; fi
            if [ -n "$sha1" ]; then calc=$(git hash-object "$path"); [ "$calc" = "$sha1" ] || bad+=("$path"); fi
          done < "$MAN"
          if [ "${#miss[@]}" -gt 0 ] || [ "${#bad[@]}" -gt 0 ]; then
            {
              printf '{"gate":"T0","status":"FAIL","checked":%s' "$checked"
              if [ "${#miss[@]}" -gt 0 ]; then
                printf ',"missing":['
                for i in "${!miss[@]}"; do printf '"%s"%s' "${miss[$i]}" $([ "$i" -lt $((${#miss[@]}-1)) ] && echo , ); done
                printf ']'
              fi
              if [ "${#bad[@]}" -gt 0 ]; then
                printf ',"sha1_mismatch":['
                for i in "${!bad[@]}"; do printf '"%s"%s' "${bad[$i]}" $([ "$i" -lt $((${#bad[@]}-1)) ] && echo , ); done
                printf ']'
              fi
              printf '}\n'
            } > "$OUT"
            cat "$OUT"; exit 1
          fi
          printf '{"gate":"T0","status":"PASS","missing":[],"checked":%s}\n' "$checked" > "$OUT"; cat "$OUT"

      - name: Upload evidência T0
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: s7-t0-evidence
          path: out/obs_gatecheck/T0_discovery.json

# tick 2025-11-02T05:01:19Z