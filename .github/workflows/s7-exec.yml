name: "S7 ORR Exec Wrapper"

on:
  workflow_dispatch:
    inputs:
      run_microbench:
        type: boolean
        required: false
        default: false
      run_tla:
        type: boolean
        required: false
        default: false

permissions:
  contents: read

concurrency:
  group: s7-orr-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  run:
    permissions:
      contents: read
      actions: write
    uses: ./.github/workflows/_s7-orr.yml
    secrets: inherit
    with:
      run_microbench: ${{ fromJSON(github.event.inputs.run_microbench || false) }}
      run_tla: ${{ fromJSON(github.event.inputs.run_tla || false) }}

  t0_echo:
    needs: run
    if: always()
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      actions: read
    steps:
      - name: Download T0 evidence
        if: always()
        continue-on-error: true
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
        with:
          name: s7-t0-evidence
          path: s7-t0-evidence

      - name: Summarise T0 discovery
        if: always()
        run: |
          set -euo pipefail
          if [[ ! -f s7-t0-evidence/T0_discovery.json ]]; then
            mkdir -p s7-t0-evidence
            cat <<JSON > s7-t0-evidence/T0_discovery.json
{"gate":"T0","status":"MISSING","checked":0,"missing":[],"badhash":[]}
JSON
          fi
          echo "T0_discovery.json contents:" >&2
          cat s7-t0-evidence/T0_discovery.json >&2
          status=$(jq -r ".status // \"UNKNOWN\"" s7-t0-evidence/T0_discovery.json 2>/dev/null || echo "UNKNOWN")
          checked=$(jq -r ".checked // 0" s7-t0-evidence/T0_discovery.json 2>/dev/null || echo 0)
          missing_count=$(jq ".missing | length" s7-t0-evidence/T0_discovery.json 2>/dev/null || echo 0)
          badhash_count=$(jq ".badhash | length" s7-t0-evidence/T0_discovery.json 2>/dev/null || echo 0)
          echo "::notice::T0 status=${status} checked=${checked} missing=${missing_count} badhash=${badhash_count}"
