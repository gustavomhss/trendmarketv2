sprint_name: Q2-S7-Stabilize
gates:
  - id: T1
    name: YAML saudável
    purpose: Sintaxe/estilo YAML antes de qualquer execução.
    ltl: 'G(valid_yaml)'
    contracts:
      require:
        - 'yamllint instalado ou instalável'
      ensure:
        - 'exit code == 0'
    run:
      - "bash -lc 'if command -v yamllint >/dev/null 2>&1; then yamllint .; else python3 -m pip install --user yamllint==1.35.1 && ~/.local/bin/yamllint .; fi'"
    assert_patterns:
      - '.'
    evidence:
      - path: out/evidence/T1_yaml/yamllint.txt
        must_exist: false

  - id: T2
    name: Pins do CI
    purpose: Verificar que ações críticas estão pinadas por SHA.
    ltl: 'G(pinned(actions))'
    contracts:
      require:
        - 'actions.lock presente'
      ensure:
        - 'todas as referencias mapeadas para SHA'
    run:
      - "bash -lc 'python3 scripts/sprint_guard.py check-pins'"
    assert_patterns:
      - 'PINS:OK'
    evidence:
      - path: out/evidence/T2_pins/report.json
        must_exist: true

  - id: T3
    name: Assinatura e Verificação
    purpose: Roundtrip de assinatura/verificação.
    ltl: 'F(passed(sign_verify))'
    contracts:
      require:
        - 'pytest disponível'
      ensure:
        - 'exit code == 0'
    run:
      - "bash -lc 'pytest -q tests/test_signature.py -k roundtrip'"
    assert_patterns:
      - 'PASSED'
    evidence:
      - path: out/evidence/T3_crypto/pytest.txt
        must_exist: false

# retrigger 2025-10-31T20:28:48Z
